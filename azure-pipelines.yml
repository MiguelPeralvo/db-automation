# mlFlow Registry QA & Prod pipeline 

trigger:
- staging
- master

pool:
  name: Hosted Ubuntu 1604

steps:
- task: UsePythonVersion@0
  displayName: 'Use Python 3.7'
  inputs:
    versionSpec: 3.7

- script: |
    pip install pytest requests setuptools wheel pyspark==2.4.5
    pip install -U databricks-cli
  displayName: 'Load Python Dependencies'

- task: riserrad.azdo-databricks.azdo-databricks-configuredatabricks.configuredatabricks@0
  inputs:
    url: '$(WORKSPACE-REGION-URL)/?o=$(WORKSPACE-ORG-ID)'
    token: '$(PERSONAL-ACCESS-TOKEN)'
  displayName: 'Configure Databricks CLI for AZDO'

#- script: |
#    dbfs ls
#  displayName: 'Check config working'

- checkout: self
  persistCredentials: true
  clean: true

- script: git checkout master
  displayName: 'Get Latest Branch'

- task: riserrad.azdo-databricks.azdo-databricks-deploynotebooks.deploynotebooks@0
  displayName: 'Deploy Notebooks to Workspace'
  inputs:
    notebooksFolderPath: '$BUILD_SOURCESDIRECTORY/"pipeline/ML/deploy/deploy_azure_ml_model.py'
    workspaceFolder: '/Users/$(USERNAME)/Demo/Test/deploy_azure_ml_model/deploy_azure_ml_model.py'

- script: |
    cat /home/vsts/.databrickscfg
    databricks workspace import $BUILD_SOURCESDIRECTORY/"pipeline/ML/deploy/deploy_azure_ml_model.py" "/Users/$(USERNAME)/Demo/Test/deploy_azure_ml_model.py"  --language PYTHON -o
  displayName: 'Import ML Deploy Notebook'
- task: PythonScript@0
  inputs:
    scriptSource: 'filePath'
    scriptPath: '$(Build.Repository.LocalPath)/cicd-scripts/executenotebook.py'
    arguments: '--shard $(DATABRICKS_HOST) --token $(DATABRICKS_TOKEN) --cluster $(EXISTING_CLUSTER_ID) --localpath $(Build.Repository.LocalPath)/pipeline/ML/deploy --workspacepath /Demo/Test --outfilepath /home/vsts/work/1/s/pipeline --params model_name=$(model_name)'
  displayName: 'Deploy mlFlow Model from Registry to Azure ML for Testing'
  
- script: |
    echo $(response)
  displayName: 'API URL'
- script: |
    databricks workspace import $BUILD_SOURCESDIRECTORY/"pipeline/ML/test/test_api.py" "/Demo/Test/test_api"  --language PYTHON -o
  displayName: 'Import ML Test Notebook'
- task: PythonScript@0
  inputs:
    scriptSource: 'filePath'
    scriptPath: '$(Build.Repository.LocalPath)/cicd-scripts/executenotebook.py'
    arguments: '--shard $(DATABRICKS_HOST) --token $(DATABRICKS_TOKEN) --cluster $(EXISTING_CLUSTER_ID) --localpath $(Build.Repository.LocalPath)/pipeline/ML/test --workspacepath /Demo/Test --outfilepath /home/vsts/work/1/s/pipeline --params model_name=$(model_name),scoring_uri=$(response)'
  displayName: 'Test mlFlow Model from Registry against REST API' 

- task: PythonScript@0
  inputs:
    scriptSource: 'filePath'
    scriptPath: '$(Build.Repository.LocalPath)/cicd-scripts/mlflow.py'
    arguments: ''
  displayName: 'Promote mlFlow Registry model to Production' 

- script: |
    echo $(response)
  displayName: 'Model Production Version'

- task: PythonScript@0
  inputs:
    scriptSource: 'filePath'
    scriptPath: '$(Build.Repository.LocalPath)/cicd-scripts/executenotebook.py'
    arguments: '--shard $(DATABRICKS_HOST) --token $(DATABRICKS_TOKEN) --cluster $(EXISTING_CLUSTER_ID) --localpath $(Build.Repository.LocalPath)/pipeline/ML/deploy --workspacepath /Demo/Test --outfilepath /home/vsts/work/1/s/pipeline --params model_name=$(model_name),stage="production,phase="prod"'
  displayName: 'Deploy mlFlow Model from Registry to Azure ML into Production'